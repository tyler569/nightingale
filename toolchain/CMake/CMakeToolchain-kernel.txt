set(CMAKE_SYSTEM_NAME Nightingale)
set(CMAKE_SYSTEM_PROCESSOR X86_64)

set(CMAKE_C_COMPILER clang)
set(CMAKE_ASM_COMPILER clang)
set(CMAKE_LINKER ld.lld)

# Skip compiler tests since we're cross-compiling
set(CMAKE_C_COMPILER_WORKS TRUE)
set(CMAKE_ASM_COMPILER_WORKS TRUE)

# Kernel-specific flags
set(CMAKE_C_FLAGS "-Wall -Wextra -ffreestanding -fstrict-aliasing -nostdlib -nostdinc -Wno-unused-variable -Wno-unused-parameter -Wno-sign-compare -Wno-address-of-packed-member -Wno-deprecated-non-prototype -fno-asynchronous-unwind-tables -fno-omit-frame-pointer -fsanitize=undefined")

# Force cross-compilation to x86_64 and set target-specific flags
set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -target x86_64-unknown-none")
set(CMAKE_ASM_FLAGS "${CMAKE_ASM_FLAGS} -target x86_64-unknown-none")

# Set up sysroot for header resolution - use absolute path since CMAKE_SOURCE_DIR may not be available
get_filename_component(NIGHTINGALE_ROOT "${CMAKE_CURRENT_LIST_DIR}/../.." ABSOLUTE)
set(CMAKE_SYSROOT "${NIGHTINGALE_ROOT}/sysroot")
set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -I${NIGHTINGALE_ROOT}/sysroot/usr/include")

# Architecture-specific flags for kernel (only for x86_64 target)
if(CMAKE_SYSTEM_PROCESSOR STREQUAL "X86_64")
    set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -mno-red-zone -mno-mmx -mno-sse -mno-sse2 -mcmodel=kernel")
endif()

set(CMAKE_C_FLAGS_DEBUG "-g -O0 -Werror")
set(CMAKE_C_FLAGS_RELEASE "-O3")
set(CMAKE_EXE_LINKER_FLAGS_DEBUG "-g")

# Kernel-specific definitions
add_compile_definitions(
    __nightingale__=1
    _NG_SOURCE=1
    __kernel__=1
)

set(CMAKE_C_STANDARD 23)

# Static linking for kernel and custom link command
set(CMAKE_EXE_LINKER_FLAGS "-static")
set(CMAKE_C_LINK_EXECUTABLE "<CMAKE_LINKER> <CMAKE_C_LINK_FLAGS> <LINK_FLAGS> <OBJECTS> -o <TARGET> <LINK_LIBRARIES>")

# Don't search for programs in host paths
set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)

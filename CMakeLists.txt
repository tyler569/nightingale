cmake_minimum_required(VERSION 3.21)

list(APPEND CMAKE_MODULE_PATH "${CMAKE_SOURCE_DIR}/toolchain/CMake")

include(ExternalProject)
include(NightingaleCommon)

set(CMAKE_C_STANDARD 23)
set(CMAKE_C_FLAGS_DEBUG "-g -O0 -Werror")
set(CMAKE_C_FLAGS_RELEASE "-O3")

# Cache variables for customization
set(nightingale_enable_ubsan ON CACHE BOOL "Enable undefined behavior sanitizer")
set(nightingale_arch "X86_64" CACHE STRING "Target architecture")

set(limine_cfg_file "${CMAKE_SOURCE_DIR}/kernel/limine.cfg")

set(limine_dir "${CMAKE_BINARY_DIR}/limine")
set(iso_file "${CMAKE_SOURCE_DIR}/ngos.iso")
set(iso_dir "${CMAKE_BINARY_DIR}/iso_root")
set(sysroot_dir "${CMAKE_BINARY_DIR}/sysroot")
set(autogen_include_dir "${CMAKE_BINARY_DIR}/autogenerated")

# Sysroot directories - where userland files are installed for initrd
set(system_include_dir "${sysroot_dir}/include")
set(system_lib_dir "${sysroot_dir}/lib")
set(system_bin_dir "${sysroot_dir}/bin")

# ISO directories - only boot files
set(iso_boot_dir "${iso_dir}/boot")
set(initrd_file "${iso_boot_dir}/initrd.tar")

file(MAKE_DIRECTORY ${autogen_include_dir})

set(CMAKE_EXE_LINKER_FLAGS_DEBUG "-g")

message(STATUS "CMAKE_BUILD_TYPE: ${CMAKE_BUILD_TYPE}")

# We do this as a manual git download as a workaround for the fact that ExternalProject_Add
# doesn't support shallow clones, or more accurately lies about its support for shallow clones.
# See: https://gitlab.kitware.com/cmake/cmake/-/issues/17770
ExternalProject_Add(limine
    SOURCE_DIR "${limine_dir}"
    DOWNLOAD_COMMAND ${CMAKE_COMMAND} -E echo "Checking limine directory..."
    COMMAND test -d ${limine_dir} || git clone --depth 1 --branch v7.x-binary https://github.com/limine-bootloader/limine.git ${limine_dir}
    CONFIGURE_COMMAND ""
    BUILD_IN_SOURCE 1
    BUILD_COMMAND test -f ${limine_dir}/limine || make -C ${limine_dir}
    INSTALL_COMMAND ""
    UPDATE_COMMAND ""
    BUILD_ALWAYS 0
)

# Create interface library for limine headers
add_library(limine_headers INTERFACE)
add_dependencies(limine_headers limine)
target_include_directories(limine_headers INTERFACE ${limine_dir})

project(nightingale C ASM)

execute_process(
    COMMAND git describe --tags
    WORKING_DIRECTORY ${CMAKE_SOURCE_DIR}
    OUTPUT_VARIABLE nightingale_version
    OUTPUT_STRIP_TRAILING_WHITESPACE
)

configure_file(include/version.h.in ${autogen_include_dir}/version.h)

list(APPEND nightingale_autogenerated_headers
    ${autogen_include_dir}/autogenerated_errnos.h
    ${autogen_include_dir}/autogenerated_syscall_consts.h
    ${autogen_include_dir}/autogenerated_syscalls_kernel.h
    ${autogen_include_dir}/autogenerated_syscalls_user.h
    ${autogen_include_dir}/autogenerated_errnos.c
    ${autogen_include_dir}/autogenerated_syscall_names.c
    ${autogen_include_dir}/autogenerated_syscalls_kernel.c
    ${autogen_include_dir}/autogenerated_syscalls_user.c
)

add_custom_command(
    OUTPUT ${nightingale_autogenerated_headers}
    COMMAND ${CMAKE_SOURCE_DIR}/script/generate_syscalls.rb ${autogen_include_dir}
    DEPENDS ${CMAKE_SOURCE_DIR}/script/generate_syscalls.rb
    DEPENDS interface/SYSCALLS interface/ERRNOS
    WORKING_DIRECTORY ${CMAKE_SOURCE_DIR}
    VERBATIM
)
add_custom_target(generate_headers DEPENDS ${nightingale_autogenerated_headers})

# Create interface library for autogenerated headers
add_library(autogen_headers INTERFACE)
add_dependencies(autogen_headers generate_headers)
target_include_directories(autogen_headers INTERFACE ${autogen_include_dir})

# Global compile options removed - now applied per target via nightingale_apply_target_properties()
# This allows better control and prevents accidental option leakage

set(CMAKE_EXE_LINKER_FLAGS "-static")

add_subdirectory(kernel)
add_subdirectory(libc)
add_subdirectory(linker)
add_subdirectory(user)

# Install regular headers to sysroot for packaging into initrd
install(DIRECTORY ${CMAKE_SOURCE_DIR}/include/
    DESTINATION include
    COMPONENT initrd
    FILES_MATCHING PATTERN "*.h"
)

# Install autogenerated headers to sysroot for packaging into initrd
install(FILES
    ${autogen_include_dir}/autogenerated_errnos.h
    ${autogen_include_dir}/autogenerated_syscall_consts.h
    ${autogen_include_dir}/autogenerated_syscalls_kernel.h
    ${autogen_include_dir}/autogenerated_syscalls_user.h
    ${autogen_include_dir}/autogenerated_errnos.c
    ${autogen_include_dir}/autogenerated_syscall_names.c
    ${autogen_include_dir}/autogenerated_syscalls_kernel.c
    ${autogen_include_dir}/autogenerated_syscalls_user.c
    ${autogen_include_dir}/version.h
    DESTINATION include
    COMPONENT initrd
)

# Install initrd component to sysroot and ISO component to ISO directory
add_custom_target(install_to_sysroot
    COMMAND ${CMAKE_COMMAND} --install ${CMAKE_BINARY_DIR} --prefix ${sysroot_dir} --component initrd
    COMMAND ${CMAKE_COMMAND} --install ${CMAKE_BINARY_DIR} --prefix ${iso_dir} --component iso
    DEPENDS nightingale_kernel kernel_modules c elf sh ${userland_programs} generate_headers
    COMMENT "Installing initrd to sysroot and ISO files to ISO directory"
)

# Create initrd from sysroot (userland files only)
find_program(tar_command NAMES gtar tar)
add_custom_command(OUTPUT ${initrd_file}
    DEPENDS install_to_sysroot
    COMMAND ${tar_command} cf ${initrd_file} -C ${sysroot_dir} .
    VERBATIM
)
add_custom_target(initrd DEPENDS ${initrd_file})

# Here we need to depend on initrd_file and not initrd because DEPENDS only directly specifies that this
# any target that uses this command must be run AFTER the dependencies and you only get an actual file
# dependency on the result if the target is an executable, library, or file.
# Essentially, having a custom_command DEPEND on a custom_target is a footgun.
add_custom_command(
    DEPENDS limine install_to_sysroot ${initrd_file} ${limine_cfg_file}
    OUTPUT ${iso_file}
    COMMAND ${CMAKE_COMMAND} -E copy ${limine_dir}/limine-bios.sys ${iso_dir}/boot/limine/limine-bios.sys
    COMMAND ${CMAKE_COMMAND} -E copy ${limine_dir}/limine-bios-cd.bin ${iso_dir}/boot/limine/limine-bios-cd.bin
    COMMAND ${CMAKE_COMMAND} -E copy ${limine_dir}/limine-uefi-cd.bin ${iso_dir}/boot/limine/limine-uefi-cd.bin
    COMMAND xorriso -as mkisofs -b boot/limine/limine-bios-cd.bin
    -no-emul-boot -boot-load-size 4 --boot-info-table
    --efi-boot boot/limine/limine-uefi-cd.bin
    -efi-boot-part --efi-boot-image --protective-msdos-label
    "${iso_dir}" -o "${iso_file}"
    COMMAND ${limine_dir}/limine bios-install ${iso_file}
    VERBATIM
)
add_custom_target(iso ALL DEPENDS ${iso_file})

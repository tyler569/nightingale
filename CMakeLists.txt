cmake_minimum_required(VERSION 3.10)

list(APPEND CMAKE_MODULE_PATH "${CMAKE_SOURCE_DIR}/toolchain/CMake")

set(CMAKE_C_STANDARD 23)
set(CMAKE_C_FLAGS_DEBUG "-g -O0 -Werror")
set(CMAKE_C_FLAGS_RELEASE "-O3")
set(CMAKE_EXE_LINKER_FLAGS_DEBUG "-g")

set(autogen_include_dir "${CMAKE_BINARY_DIR}/autogenerated" CACHE PATH "Directory for autogenerated headers")

file(MAKE_DIRECTORY ${autogen_include_dir})

message(STATUS "CMAKE_BUILD_TYPE: ${CMAKE_BUILD_TYPE}")

project(nightingale C ASM)

execute_process(
    COMMAND git describe --tags
    WORKING_DIRECTORY ${CMAKE_SOURCE_DIR}
    OUTPUT_VARIABLE nightingale_version
    OUTPUT_STRIP_TRAILING_WHITESPACE
)

configure_file(include/version.h.in ${autogen_include_dir}/version.h)

list(APPEND nightingale_autogenerated_headers
    ${autogen_include_dir}/autogenerated_errnos.h
    ${autogen_include_dir}/autogenerated_syscall_consts.h
    ${autogen_include_dir}/autogenerated_syscalls_kernel.h
    ${autogen_include_dir}/autogenerated_syscalls_user.h
    ${autogen_include_dir}/autogenerated_errnos.c
    ${autogen_include_dir}/autogenerated_syscall_names.c
    ${autogen_include_dir}/autogenerated_syscalls_kernel.c
    ${autogen_include_dir}/autogenerated_syscalls_user.c
)

add_custom_command(
    OUTPUT ${nightingale_autogenerated_headers}
    COMMAND ${CMAKE_SOURCE_DIR}/script/generate_syscalls.rb ${autogen_include_dir}
    DEPENDS ${CMAKE_SOURCE_DIR}/script/generate_syscalls.rb
    DEPENDS interface/syscalls.yml interface/errnos.yml
    WORKING_DIRECTORY ${CMAKE_SOURCE_DIR}
)
add_custom_target(generate_headers DEPENDS ${nightingale_autogenerated_headers})

add_compile_options(
    -Wall
    -Wextra
    -ffreestanding
    -fstrict-aliasing
    -nostdlib
    -nostdinc
    -Wno-unused-variable
    -Wno-unused-parameter
    -Wno-sign-compare
    -Wno-address-of-packed-member
    -Wno-deprecated-non-prototype
)

add_compile_definitions(
    __nightingale__=1
    _NG_SOURCE=1
)

set(CMAKE_EXE_LINKER_FLAGS "-static")

include_directories(include)
include_directories(${autogen_include_dir})

add_subdirectory(kernel)
add_subdirectory(libc)
add_subdirectory(modules)

add_dependencies(nightingale_kernel generate_headers)
add_dependencies(c generate_headers)
add_dependencies(elf generate_headers)

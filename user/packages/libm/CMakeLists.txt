# libm package - math library from sortix-libm using native Makefile

set(LIBM_URL "https://github.com/tyler569/sortix-libm/archive/refs/tags/1.0.tar.gz")
set(LIBM_PACKAGE_DIR "${CMAKE_BINARY_DIR}/packages/libm")

# Download and extract
download_package(libm "${LIBM_URL}")

# Find the extracted directory (it will be named sortix-libm-1.0)
file(GLOB LIBM_SRC_DIR "${LIBM_PACKAGE_DIR}/sortix-libm-*")
list(GET LIBM_SRC_DIR 0 LIBM_SRC_DIR)

# Apply any patches to the extracted source directory
set(PATCHES_DIR "${CMAKE_CURRENT_SOURCE_DIR}/patches")
if(EXISTS "${PATCHES_DIR}")
    file(GLOB PATCH_FILES "${PATCHES_DIR}/*.patch")
    foreach(PATCH_FILE ${PATCH_FILES})
        message(STATUS "Applying patch: ${PATCH_FILE}")
        execute_process(
            COMMAND patch -p1 -i "${PATCH_FILE}"
            WORKING_DIRECTORY "${LIBM_SRC_DIR}"
            RESULT_VARIABLE PATCH_RESULT
        )
        if(NOT PATCH_RESULT EQUAL 0)
            message(FATAL_ERROR "Failed to apply patch: ${PATCH_FILE}")
        endif()
    endforeach()
endif()

# Create the build-aux directory and required files for the Makefile
file(MAKE_DIRECTORY "${LIBM_SRC_DIR}/../build-aux")

# Create minimal platform.mak
file(WRITE "${LIBM_SRC_DIR}/../build-aux/platform.mak" "HOST=x86_64-unknown-none\n")

# Create minimal compiler.mak  
file(WRITE "${LIBM_SRC_DIR}/../build-aux/compiler.mak" 
     "CC=${CMAKE_C_COMPILER}\n"
     "AR=${CMAKE_AR}\n"
     "CFLAGS=${CMAKE_C_FLAGS} -target x86_64-unknown-none -I${CMAKE_SOURCE_DIR}/include -I${CMAKE_BINARY_DIR}/autogenerated -nostdlib -nostdinc -ffreestanding -D_IEEE_LIBM -D__nightingale__=1 -D_NG_SOURCE=1 -D__USE_SORTIX=1 -D__USE_C=1999 -include libm_compat.h\n"
     "CPPFLAGS=-I${CMAKE_SOURCE_DIR}/include -I${CMAKE_BINARY_DIR}/autogenerated\n")

# Create minimal version.mak
file(WRITE "${LIBM_SRC_DIR}/../build-aux/version.mak" "VERSION=1.0\n")

# Create minimal dirs.mak
file(WRITE "${LIBM_SRC_DIR}/../build-aux/dirs.mak" 
     "INCLUDEDIR=${system_include_dir}\n"
     "LIBDIR=${system_lib_dir}\n"
     "DESTDIR=\n")

# Use ExternalProject to build with the native Makefile
add_custom_command(
    OUTPUT "${LIBM_SRC_DIR}/libm.a"
    COMMAND make -C "${LIBM_SRC_DIR}" libm.a
    DEPENDS "${LIBM_SRC_DIR}/../build-aux/platform.mak"
    WORKING_DIRECTORY "${LIBM_SRC_DIR}"
    COMMENT "Building libm using native Makefile"
)

# Create a custom target for the library
add_custom_target(libm_build DEPENDS "${LIBM_SRC_DIR}/libm.a")

# Create an imported library target
add_library(m STATIC IMPORTED GLOBAL)
set_target_properties(m PROPERTIES
    IMPORTED_LOCATION "${LIBM_SRC_DIR}/libm.a"
    INTERFACE_INCLUDE_DIRECTORIES "${LIBM_SRC_DIR}/include"
)
add_dependencies(m libm_build)

# Install the library and headers
install(FILES "${LIBM_SRC_DIR}/libm.a" DESTINATION lib RENAME libm.a)
install(DIRECTORY "${LIBM_SRC_DIR}/include/" DESTINATION include 
        FILES_MATCHING PATTERN "*.h")
# Lua package - Lua programming language using native Makefile

set(LUA_URL "https://lua.org/ftp/lua-5.4.8.tar.gz")
set(LUA_PACKAGE_DIR "${CMAKE_BINARY_DIR}/packages/lua")

# Download and extract
download_package(lua "${LUA_URL}")

# Find the extracted directory (it will be named lua-5.4.8)
file(GLOB LUA_SRC_DIR "${LUA_PACKAGE_DIR}/lua-*")
list(GET LUA_SRC_DIR 0 LUA_SRC_DIR)

# Apply patches for Nightingale support
apply_patches(lua)

# Collect lua source files for dependency tracking
file(GLOB_RECURSE LUA_SOURCES 
    "${LUA_SRC_DIR}/src/*.c"
    "${LUA_SRC_DIR}/src/*.h"
)

# Use native Makefile to build lua library only (not executables)
add_custom_command(
    OUTPUT "${LUA_SRC_DIR}/src/liblua.a"
    COMMAND make clean liblua.a
        CC="${CMAKE_C_COMPILER}"
        "AR=${CMAKE_AR} rcs"
        RANLIB="${CMAKE_RANLIB}"
        "CFLAGS=${CMAKE_C_FLAGS} -target x86_64-unknown-none -I${CMAKE_SOURCE_DIR}/include -I${CMAKE_BINARY_DIR}/autogenerated -I${system_include_dir} -nostdlib -nostdinc -ffreestanding -D__nightingale__=1 -D_NG_SOURCE=1 -DLUA_USE_POSIX"
    DEPENDS 
        "${CMAKE_SOURCE_DIR}/include/sys/cdefs.h"
        libm_deploy
        ${LUA_SOURCES}
    WORKING_DIRECTORY "${LUA_SRC_DIR}/src"
    COMMENT "Building lua using native Makefile"
)

# Create custom target for the library
add_custom_target(lua_lib_build DEPENDS "${LUA_SRC_DIR}/src/liblua.a")

# Create imported library targets
add_library(lua_static STATIC IMPORTED GLOBAL)
set_target_properties(lua_static PROPERTIES
    IMPORTED_LOCATION "${LUA_SRC_DIR}/src/liblua.a"
    INTERFACE_INCLUDE_DIRECTORIES "${LUA_SRC_DIR}/src"
)
add_dependencies(lua_static lua_lib_build)

# Build lua executables using CMake linking (compatible with Nightingale)
add_executable(lua_pkg "${LUA_SRC_DIR}/src/lua.c")
target_link_libraries(lua_pkg lua_static c m)
target_include_directories(lua_pkg PRIVATE "${LUA_SRC_DIR}/src")
add_dependencies(lua_pkg lua_lib_build)
set_target_properties(lua_pkg PROPERTIES OUTPUT_NAME lua)

add_executable(luac_pkg "${LUA_SRC_DIR}/src/luac.c")
target_link_libraries(luac_pkg lua_static c m)
target_include_directories(luac_pkg PRIVATE "${LUA_SRC_DIR}/src")
add_dependencies(luac_pkg lua_lib_build)
set_target_properties(luac_pkg PROPERTIES OUTPUT_NAME luac)

# Deploy lua executables to /bin in initfs
install(TARGETS lua_pkg DESTINATION bin)
install(TARGETS luac_pkg DESTINATION bin)

# Deploy lua library and headers to system directories for tarfs inclusion
add_custom_command(
    OUTPUT "${system_lib_dir}/liblua.a"
    COMMAND ${CMAKE_COMMAND} -E copy "${LUA_SRC_DIR}/src/liblua.a" "${system_lib_dir}/liblua.a"
    DEPENDS "${LUA_SRC_DIR}/src/liblua.a"
    COMMENT "Deploying liblua.a to system lib directory"
)

add_custom_command(
    OUTPUT "${system_include_dir}/lua.h"
    COMMAND ${CMAKE_COMMAND} -E copy "${LUA_SRC_DIR}/src/lua.h" "${system_include_dir}/lua.h"
    COMMAND ${CMAKE_COMMAND} -E copy "${LUA_SRC_DIR}/src/luaconf.h" "${system_include_dir}/luaconf.h"
    COMMAND ${CMAKE_COMMAND} -E copy "${LUA_SRC_DIR}/src/lualib.h" "${system_include_dir}/lualib.h"
    COMMAND ${CMAKE_COMMAND} -E copy "${LUA_SRC_DIR}/src/lauxlib.h" "${system_include_dir}/lauxlib.h"
    DEPENDS "${LUA_SRC_DIR}/src/liblua.a"
    COMMENT "Deploying lua headers to system include directory"
)

add_custom_target(lua_deploy 
    DEPENDS "${system_lib_dir}/liblua.a" "${system_include_dir}/lua.h"
)
add_dependencies(lua_deploy lua_lib_build)
